<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>景点评分与评论分析</title>

    <!-- 引入 Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- 引入 Select2 的 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />

    <!-- 引入 ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>

    <!-- 引入 jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- 引入 Select2 的 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

       <style>
        /* 通用样式 */
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
        }

        /* 主标题和下拉框容器样式 */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 10px 20px; /* 减小 padding */
        }

        h1 {
            font-size: 2rem;
            color: #333;
            margin: 0;
            margin-bottom: 10px; /* 减小与下拉框的间距 */
        }

        /* 下拉框样式 */
        label {
            font-size: 1.2rem;
            color: #555;
            margin-right: 10px;
        }

        select {
            padding: 8px; /* 减小 padding */
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            width: 220px;
        }

        select:focus {
            border-color: #007bff;
            outline: none;
        }

        /* 图表容器样式 */
        .chart-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 10px; /* 减小 padding */
            transition: transform 0.3s ease-in-out;
            margin-top: 5px; /* 减小与其他元素的间距 */
            height: 390px; /* 主图表容器的高度 */
        }

        .chart-container:hover {
            transform: translateY(-5px);
        }

        /* 图表标题 */
        .chart-title {
            text-align: center;
            font-size: 1.3rem; /* 缩小标题字体 */
            color: #333;
            margin-bottom: 10px; /* 缩小标题与图表之间的间距 */
        }

        /* 主图表样式：单独占一整行 */
        .main-chart-container {
            width: 100%;
            max-width: 1200px;
        }

        /* 评论数量和评分排序图表容器：放在同一行 */
        .sorted-charts-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin-top: 5px; /* 减小与主图表的间距 */
        }

        .sorted-charts-container .chart-container {
            flex: 1;
            margin-right: 20px;
            height: 290px; /* 更小的图表容器高度 */
        }

        .sorted-charts-container .chart-container:last-child {
            margin-right: 0;
        }

        /* 响应式布局 */
        @media (max-width: 768px) {
            .sorted-charts-container {
                flex-direction: column;
            }

            .sorted-charts-container .chart-container {
                margin-bottom: 15px; /* 减小垂直间距 */
                height: 180px; /* 更小的高度 */
            }

            select {
                width: 100%;
            }

            .header-container {
                flex-direction: column;
                align-items: flex-start;
            }

            h1 {
                margin-bottom: 5px; /* 减小标题与下拉框的间距 */
            }
        }
    </style>
</head>
<body>
    <!-- 主标题和下拉框放在同一行 -->
    <div class="header-container">
        <h1>市级评分与评论分析</h1>
        <div style="display: flex; flex-direction: column; align-items: flex-end;">
            <label for="districtSelect"></label>
            <select id="districtSelect">
                <option value="">请选择地区</option>
                {% for district in districts %}
                    <option value="{{ district }}">{{ district }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- 主图表容器：景点评分与评论数量 -->
    <div class="main-chart-container">
        <div class="chart-container">
            <div class="chart-title">景点评分与评论数量</div>
            <div id="chart" style="height: 400px;"></div>
        </div>
    </div>

    <!-- 评论数量排序和评分排序图表：同一行 -->
    <div class="sorted-charts-container">
        <!-- 评论数量排序图表 -->
        <div class="chart-container">
            <div class="chart-title">评论数量排序</div>
            <div id="commentCountChart" style="height: 300px;"></div>
        </div>

        <!-- 评分排序图表 -->
        <div class="chart-container">
            <div class="chart-title">评分排序</div>
            <div id="commentScoreChart" style="height: 300px;"></div>
        </div>
    </div>

    <script>
        // 初始化 Select2
        $(document).ready(function() {
            $('#districtSelect').select2({
                placeholder: "请选择地区", // 默认显示的提示信息
                allowClear: true, // 允许清除选项
                width: 'resolve' // 自动调整宽度
            });

            // 监听下拉框的选择变化
            $('#districtSelect').on('change', function() {
                var district = $(this).val(); // 获取选中的地区
                if (district) {
                    // 请求数据
                    fetch(`/get_data?district=${district}`)
                        .then(response => response.json())
                        .then(data => {
                            // 清空之前的图表数据
                            clearCharts();

                            // 渲染新的图表
                            renderCharts(data);
                        })
                        .catch(error => console.error('Error fetching data:', error));
                }
            });
        });

        // 清空所有图表
        function clearCharts() {
            var chartDom = document.getElementById('chart');
            var commentCountChartDom = document.getElementById('commentCountChart');
            var commentScoreChartDom = document.getElementById('commentScoreChart');

            if (chartDom) echarts.getInstanceByDom(chartDom)?.dispose();
            if (commentCountChartDom) echarts.getInstanceByDom(commentCountChartDom)?.dispose();
            if (commentScoreChartDom) echarts.getInstanceByDom(commentScoreChartDom)?.dispose();
        }

        // 渲染所有图表
        function renderCharts(data) {
            renderMainChart(data);
            renderCommentCountChart(data);
            renderCommentScoreChart(data);
        }

        // 渲染主图：评论数量与评分双轴图
        function renderMainChart(data) {
            const uniqueData = removeDuplicates(
                data.names.map((name, index) => ({
                    name: name,
                    commentCount: data.commentCounts[index],
                    commentScore: data.commentScores[index]
                }))
            );

            const names = uniqueData.map(item => item.name);
            const commentCounts = uniqueData.map(item => item.commentCount);
            const commentScores = uniqueData.map(item => item.commentScore);

            var chartDom = document.getElementById('chart');
            var myChart = echarts.init(chartDom);

            var option = {
                title: {
                    text: ''
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['评论数量', '评论评分']
                },
                xAxis: {
                    type: 'category',
                    data: names
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '评论数量',
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: '评分',
                        position: 'right'
                    }
                ],
                series: [
                    {
                        name: '评论数量',
                        type: 'bar',
                        data: commentCounts
                    },
                    {
                        name: '评论评分',
                        type: 'line',
                        yAxisIndex: 1,
                        data: commentScores
                    }
                ]
            };

            myChart.setOption(option);
        }

        // 渲染评论数量排序柱状图（每次显示10个数据）
        function renderCommentCountChart(data) {
            var sortedByCount = removeDuplicates(
                data.names.map((name, index) => ({
                    name: name,
                    commentCount: data.commentCounts[index],
                    commentScore: data.commentScores[index]
                })).sort((a, b) => b.commentCount - a.commentCount)
            );

            var names = sortedByCount.map(item => item.name);
            var commentCounts = sortedByCount.map(item => item.commentCount);

            var chartDom = document.getElementById('commentCountChart');
            var myChart = echarts.init(chartDom);

            var currentIndex = 0; // 当前显示的数据索引

            var colors = generateRandomColors(names.length);

            var option = {
                title: {
                    text: ''
                },
                tooltip: {
                    trigger: 'axis'
                },
                yAxis: {
                    type: 'category',
                    data: names.slice(currentIndex, currentIndex + 5)
                },
                xAxis: {
                    type: 'value',
                    name: '评论'
                },
                series: [
                    {
                        data: commentCounts.slice(currentIndex, currentIndex + 5),
                        type: 'bar',
                        itemStyle: {
                            color: function(params) {
                                return colors[params.dataIndex];
                            }
                        }
                    }
                ]
            };

            myChart.setOption(option);

            // 每10秒切换显示的数据
            setInterval(function() {
                currentIndex = (currentIndex + 5) % names.length;
                myChart.setOption({
                    yAxis: {
                        data: names.slice(currentIndex, currentIndex + 5)
                    },
                    series: [
                        {
                            data: commentCounts.slice(currentIndex, currentIndex + 5),
                            itemStyle: {
                                color: function(params) {
                                    return colors[params.dataIndex];
                                }
                            }
                        }
                    ]
                });
            }, 5000);
        }

        // 渲染评分排序柱状图（每次显示10个数据）
        function renderCommentScoreChart(data) {
            var sortedByScore = removeDuplicates(
                data.names.map((name, index) => ({
                    name: name,
                    commentCount: data.commentCounts[index],
                    commentScore: data.commentScores[index]
                })).sort((a, b) => b.commentScore - a.commentScore)
            );

            var names = sortedByScore.map(item => item.name);
            var commentScores = sortedByScore.map(item => item.commentScore);

            var chartDom = document.getElementById('commentScoreChart');
            var myChart = echarts.init(chartDom);

            var currentIndex = 0;

            var colors = generateRandomColors(names.length);

            var option = {
                title: {
                    text: ''
                },
                tooltip: {
                    trigger: 'axis'
                },
                yAxis: {
                    type: 'category',
                    data: names.slice(currentIndex, currentIndex + 5)
                },
                xAxis: {
                    type: 'value',
                    name: '评分'
                },
                series: [
                    {
                        data: commentScores.slice(currentIndex, currentIndex + 5),
                        type: 'bar',
                        itemStyle: {
                            color: function(params) {
                                return colors[params.dataIndex];
                            }
                        }
                    }
                ]
            };

            myChart.setOption(option);

            // 每10秒切换显示的数据
            setInterval(function() {
                currentIndex = (currentIndex + 5) % names.length;
                myChart.setOption({
                    yAxis: {
                        data: names.slice(currentIndex, currentIndex + 5)
                    },
                    series: [
                        {
                            data: commentScores.slice(currentIndex, currentIndex + 5),
                            itemStyle: {
                                color: function(params) {
                                    return colors[params.dataIndex];
                                }
                            }
                        }
                    ]
                });
            }, 5000);
        }

        // 去重函数
        function removeDuplicates(data) {
            let seen = new Set();
            return data.filter(item => {
                if (seen.has(item.name)) {
                    return false;
                } else {
                    seen.add(item.name);
                    return true;
                }
            });
        }

        // 随机生成颜色
        function generateRandomColors(count) {
            let colors = [];
            for (let i = 0; i < count; i++) {
                colors.push('#' + Math.floor(Math.random() * 16777215).toString(16));
            }
            return colors;
        }
    </script>
</body>
</html>
